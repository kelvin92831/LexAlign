# 文檔更新日誌

**更新日期**：2025-10-14  
**更新原因**：系統實作與文檔不一致，需同步更新

---

## 更新摘要

本次更新涵蓋 4 份核心文檔，主要反映以下系統變更：

1. ✅ 內規文件改為自動載入（從 `data/internal_rules` 資料夾）
2. ✅ 法規解析器改用 HTML 解析（Mammoth + Cheerio）
3. ✅ LLM 上下文改為完整文件（而非片段）
4. ✅ 建議輸出改為按文件分組
5. ✅ Word 報告改為按文件分組
6. ✅ Gemini 模型更新為 gemini-2.5-pro

---

## 文檔更新詳情

### 1. API.md

#### 主要更新

**A. API 端點變更**

| 原端點 | 新端點 | 變更說明 |
|--------|--------|----------|
| `POST /api/upload/policy` | ❌ 移除 | 改為自動載入 |
| `POST /api/upload/policy/batch` | ❌ 移除 | 改為自動載入 |
| - | ✅ `POST /api/upload/policy/auto-load` | 自動載入內規 |
| - | ✅ `GET /api/upload/policy/check` | 檢查內規資料夾 |

**B. 回應格式更新**

- 建議生成 API (`POST /api/suggest`) 現在回傳兩種格式：
  - `suggestions`：按法規條文（原有格式）
  - `suggestions_by_document`：按內規文件（新增）

**C. 使用流程更新**

```diff
- // 2. 批次上傳內規文件
- await fetch('/api/upload/policy/batch', {
-   method: 'POST',
-   body: formData,
- });

+ // 2. 自動載入內規文件（從 data/internal_rules 資料夾）
+ await fetch('/api/upload/policy/auto-load', {
+   method: 'POST',
+ });
```

**D. 注意事項更新**

- 新增：內規文件位置必須為 `data/internal_rules` 資料夾
- 新增：API 同時返回兩種建議格式說明

---

### 2. ARCHITECTURE.md

#### 主要更新

**A. 技術棧更新**

```diff
- **文件解析**: Mammoth (docx → text)
+ **文件解析**: Mammoth (docx → HTML/text) + Cheerio (HTML 解析)

- **AI 模型**: Google Generative AI SDK
+ **AI 模型**: Google Generative AI SDK (Gemini 2.5 Pro)
```

**B. 法規解析器流程更新**

```diff
處理流程：
- 1. 使用 Mammoth 讀取文件
- 2. 識別章節標題（第X條）
- 3. 提取修正條文、現行條文、說明
- 4. 判斷差異類型（新增/修正/刪除）

+ 1. 使用 Mammoth 轉換為 HTML
+ 2. 使用 Cheerio 解析 HTML 表格結構
+ 3. 識別章節標題（第X條）
+ 4. 提取修正條文、現行條文、說明
+ 5. 判斷差異類型（新增/修正/刪除）
```

**C. Gemini Service 更新**

```diff
- **輸入**: 法規修正項目 + 相關內規片段
+ **輸入**: 法規修正項目 + **完整內規文件**（而非片段）

參數：
- Max Tokens: 2048
+ Max Tokens: 8192（支援長文件）

+ **上下文增強**:
+   - 優先傳送 Top-1 最相關的完整文件
+   - 標記最相關章節供 LLM 參考
+   - 保留文件結構和上下文
```

**D. API 端點更新**

新增端點：
- `POST /api/upload/policy/auto-load`：自動載入內規
- `GET /api/upload/policy/check`：檢查內規資料夾
- `POST /api/match/test-search`：測試 RAG 檢索

**E. 資料模型新增**

新增 `SuggestionByDocument` 資料結構（按文件分組格式）

**F. 技術債務更新**

```diff
已知限制：
- 1. 無法處理複雜表格結構
+ 1. ~~無法處理複雜表格結構~~（已解決：使用 HTML 解析）
+ 5. 內規文件需手動放置於 `data/internal_rules` 資料夾

改進方向：
- 1. 實作表格解析增強
+ 1. ~~實作表格解析增強~~（已完成）
+ 5. 實作 Web 介面的內規文件管理功能
+ 6. 優化 RAG 檢索策略（查詢增強、重排序）
```

---

### 3. USER_GUIDE.md

#### 主要更新

**A. 步驟 1：準備文件**

```diff
#### 公司內規文件

- 格式：`.docx`
- 數量：1-50 份
- 內容：公司現行的內部規章制度

+ - 格式：`.docx`
+ - 位置：放置於專案的 `data/internal_rules` 資料夾
+ - 內容：公司現行的內部規章制度
+ - 說明：系統會自動讀取此資料夾內的所有 .docx 文件
```

**B. 步驟 2：上傳文件**

完全重寫為新的工作流程：

```diff
- 1. 開啟系統首頁
- 2. 點擊「法規修正對照表」上傳區
- 3. 選擇法規文件（單一 .docx 檔案）
- 4. 點擊「公司內規文件」上傳區
- 5. 選擇多個內規文件（可批次選擇）
- 6. 確認檔案清單無誤
- 7. 點擊「開始上傳並分析」按鈕

+ 1. **確認內規文件已放置**：將所有內規文件放入 `data/internal_rules` 資料夾
+ 2. **開啟系統首頁**：可看到「內規資料夾狀態」顯示找到的文件數量
+ 3. **上傳法規文件**：
+    - 點擊「法規修正對照表」上傳區
+    - 選擇法規文件（單一 .docx 檔案）
+ 4. **確認資訊無誤**：檢查內規文件數量和法規文件名稱
+ 5. **開始分析**：點擊「開始分析」按鈕
```

**C. 階段說明更新**

```diff
#### 階段 1：文件解析
- （約 10-20 秒）
+ （約 10-30 秒）

- 解析法規對照表，提取修正條文
- 解析內規文件，建立向量索引

+ - 解析法規對照表，提取修正條文
+ - 自動載入 `data/internal_rules` 資料夾的所有內規文件
+ - 建立向量索引

#### 階段 3：AI 建議生成
- （約 30-60 秒）
+ （約 30-90 秒）

+ - 傳送**完整內規文件**（而非片段）給 AI
```

**D. 步驟 4：查看結果**

新增雙視圖說明：

```diff
- 分析完成後，系統將顯示修改建議清單。
+ 分析完成後，系統提供兩種檢視方式：
+ 
+ #### 📁 按文件分組檢視（預設）
+ - 以內規文件為單位分組顯示
+ - 適合實際修訂內規時使用
+ 
+ #### 📋 按法規條文檢視
+ - 以法規修正條文為單位顯示
+ - 適合追蹤法規遵循狀況
```

**E. Word 報告結構更新**

完全重寫為文件分組格式：

- 標題頁 + 文件分組章節
- 每個內規文件獨立一節
- 文件類型標記（主規章 / 附件範本）

**F. 常見問題更新**

- Q2：說明不需手動上傳，只需放在資料夾
- Q3：更新處理時間估算（因傳送完整文件，時間較長）

**G. 最佳實踐更新**

文件準備：
- 新增檔案命名建議
- 強調放置於 `data/internal_rules` 資料夾

結果審核：
- 新增「使用文件分組檢視」建議

---

### 4. DEPLOYMENT.md

✅ **無需更新**

此文檔主要為部署相關的通用指南，與系統功能變更無關。

---

## 新增文檔

### RAG_OPTIMIZATION.md

**目的**：記錄 RAG 系統優化建議，供未來改進參考

**內容摘要**：

1. **現況分析**：當前 RAG 實作與主要問題
2. **優化方案**：
   - 方案 1：優化查詢構建（⭐⭐⭐⭐⭐）
   - 方案 2：改進文件切塊策略（⭐⭐⭐⭐）
   - 方案 3：添加重排序機制（⭐⭐⭐）
   - 方案 4：升級 Embedding 模型（⭐⭐）
3. **實施計畫**：分三階段漸進式實施
4. **評估指標**：檢索質量指標與測試方法

---

## 更新前後對比

### 工作流程對比

**更新前**：
```
1. 上傳法規文件
2. 手動上傳內規文件（可多個）
3. 執行比對
4. 生成建議（按法規）
5. 下載報告（按法規）
```

**更新後**：
```
1. 將內規文件放入 data/internal_rules 資料夾
2. 上傳法規文件
3. 系統自動載入內規
4. 執行比對
5. 生成建議（雙格式：按法規 + 按文件）
6. 下載報告（按文件分組）
```

### API 變更對比

| 功能 | 更新前 | 更新後 |
|------|--------|--------|
| 上傳內規 | `POST /api/upload/policy/batch` | `POST /api/upload/policy/auto-load` |
| 檢查內規 | ❌ 無 | `GET /api/upload/policy/check` |
| 建議格式 | 僅 `suggestions` | `suggestions` + `suggestions_by_document` |
| LLM 輸入 | 內規片段 | 完整內規文件 |
| Max Tokens | 2048 | 8192 |

---

## 文檔一致性檢查清單

- [x] API.md：API 端點與系統實作一致
- [x] API.md：回應格式與實際回應一致
- [x] API.md：使用流程反映當前工作流
- [x] ARCHITECTURE.md：技術棧描述準確
- [x] ARCHITECTURE.md：模組流程描述完整
- [x] ARCHITECTURE.md：資料模型完整
- [x] USER_GUIDE.md：使用步驟反映實際 UI
- [x] USER_GUIDE.md：報告格式說明準確
- [x] USER_GUIDE.md：常見問題回答正確
- [x] DEPLOYMENT.md：部署指南仍然有效
- [x] 新增 RAG_OPTIMIZATION.md 優化建議文檔

---

## 後續維護建議

1. **定期檢查**：每次重大功能更新後檢查文檔是否需要同步
2. **版本標記**：在每份文檔末尾標記更新日期
3. **變更日誌**：重大變更應更新本日誌文件
4. **用戶反饋**：收集用戶反饋，優化文檔可讀性

---

## 總結

本次更新確保了所有核心文檔與當前系統實作完全一致，並新增了 RAG 優化建議文檔供未來改進參考。文檔現在準確反映了系統的工作流程、API 設計和使用方式。

**更新者**：AI Assistant  
**審核狀態**：待用戶確認

