# 修改建議策略更新：相似度優先

## 🎯 更新目標

### 之前的邏輯
對於每個外規修正條文，生成建議時**優先選擇主規章**，即使附件範本的相似度更高。

排序邏輯：
1. 主規章優先
2. 再按相似度排序

### 現在的邏輯  
對於每個外規修正條文，生成建議時**選擇相似度最高的文件**，不論是主規章還是附件範本。

排序邏輯：
1. **只按相似度排序**（距離越小越相關）

---

## 🔧 修改內容

### 1. 文件排序邏輯（suggest.js）

**文件**: `backend/src/routes/suggest.js`

**修改位置**: Line 226-230

#### 之前：
```javascript
// 2. 排序：主規章優先，然後按相似度
const sortedDocs = Object.values(docGroups).sort((a, b) => {
  // 主規章優先
  if (a.isMain && !b.isMain) return -1;
  if (!a.isMain && b.isMain) return 1;
  // 相似度排序
  return a.bestDistance - b.bestDistance;
});
```

#### 現在：
```javascript
// 2. 排序：只按相似度（不再優先主規章）
const sortedDocs = Object.values(docGroups).sort((a, b) => {
  // 直接按相似度排序（距離越小越相關）
  return a.bestDistance - b.bestDistance;
});
```

---

### 2. Prompt 指引（gemini-service.js）

**文件**: `backend/src/services/llm/gemini-service.js`

#### 修改點 1: 文件類型描述（Line 115-118）

**之前：**
```javascript
文件：${ctx.doc_name}
文件類型：${ctx.is_primary ? '⭐ 主規章（優先參考）' : '附件範本'}
相似度分數：${ctx.distance?.toFixed(3) || 'N/A'}
```

**現在：**
```javascript
文件：${ctx.doc_name}
文件類型：${ctx.is_primary ? '主規章' : '附件範本'}
相似度分數：${ctx.distance?.toFixed(3) || 'N/A'}（距離越小越相關）
```

同時，第一個文件（相似度最高）會被標記為：
```
【完整內規文件 1】✨ 最相關文件（建議修改此文件）
```

---

#### 修改點 2: 分析指引（Line 160-166）

**之前：**
```
# 分析指引
1. **優先參考標記為「✨ 主要參考文件」的完整文件**
2. **主規章（⭐標記）的優先級高於附件範本**
3. 仔細閱讀「最相關章節」標記的部分，但也要縱觀整份文件
4. 補充參考片段僅作為輔助參考
5. 請在完整文件中定位需要修改的具體位置（章、節、條、款、項）
6. 建議修改應基於文件中的實際條文內容
```

**現在：**
```
# 分析指引
1. **優先參考標記為「✨ 最相關文件」的完整文件（即相似度分數最低的文件）**
2. **建議修改相似度最高的文件**，不論是主規章還是附件範本
3. 仔細閱讀「最相關章節」標記的部分，但也要縱觀整份文件
4. 如有多份文件，補充文件僅作為參考，不建議修改
5. 請在完整文件中定位需要修改的具體位置（章、節、條、款、項）
6. 建議修改應基於文件中的實際條文內容
```

---

#### 修改點 3: 輸出要求（Line 172）

**之前：**
```json
{
  "file": "受影響的內規文件名稱（字符串，請使用完整文件名，優先使用主規章）",
  ...
}
```

**現在：**
```json
{
  "file": "受影響的內規文件名稱（字符串，請使用相似度分數最低的文件名稱）",
  ...
}
```

---

## 📊 影響範圍

### 影響的功能
- ✅ 建議生成流程
- ✅ 文件選擇邏輯
- ✅ LLM Prompt 指引

### 不影響的功能
- ✅ RAG 檢索邏輯（已經是按相似度）
- ✅ 前端顯示邏輯
- ✅ 下載報告功能

---

## 🎯 預期效果

### 場景 1: 附件範本更相關

| 法規條文 | 主規章相似度 | 附件範本相似度 | 之前選擇 | 現在選擇 |
|---------|------------|--------------|---------|---------|
| 合約資安條款修正 | 0.65 | 0.42 | 主規章 | 附件範本 ✅ |

### 場景 2: 主規章更相關

| 法規條文 | 主規章相似度 | 附件範本相似度 | 之前選擇 | 現在選擇 |
|---------|------------|--------------|---------|---------|
| 委外管理定義修正 | 0.38 | 0.72 | 主規章 ✅ | 主規章 ✅ |

**關鍵差異**: 現在會**動態選擇最相關的文件**，而不是固定優先主規章。

---

## 🧪 測試驗證

### 測試步驟

1. **重新生成建議**
   ```bash
   # 使用已有的 match 結果重新生成
   curl -X POST http://localhost:3001/api/suggest \
     -H "Content-Type: application/json" \
     -d '{"taskId": "YOUR_TASK_ID"}'
   ```

2. **檢查建議結果**
   ```bash
   # 查看建議結果
   cat backend/tmp/uploads/suggestions_YOUR_TASK_ID.json | jq '.suggestions[] | {file, distance: .trace.policy_anchor}'
   ```

3. **驗證邏輯**
   - 檢查每個建議的 `file` 欄位
   - 對照 match 結果中的相似度分數
   - 確認選擇的是相似度最高的文件

### 預期結果

- ✅ 每個外規條文對應**相似度最高**的內規文件
- ✅ 不再固定優先主規章
- ✅ 附件範本可以被選為修改目標
- ✅ 建議更加精準和相關

---

## 📝 實例對比

### 實例：法規第二條（名詞定義）修正

假設檢索結果：
```json
[
  {
    "doc_name": "SO-02-002_資訊服務供應商委外風險管理作業程序_v3.7.docx",
    "distance": 0.58,
    "is_main": true
  },
  {
    "doc_name": "SO-02-002-F08_設備採購暨系統整合服務合約書範本_v2.8.docx", 
    "distance": 0.45,
    "is_main": false
  }
]
```

#### 之前的選擇
```json
{
  "file": "SO-02-002_資訊服務供應商委外風險管理作業程序_v3.7.docx",
  "reason": "主規章優先..."
}
```

#### 現在的選擇
```json
{
  "file": "SO-02-002-F08_設備採購暨系統整合服務合約書範本_v2.8.docx",
  "reason": "此文件的合約範本更符合法規修正的具體要求..."
}
```

---

## ✅ 變更總結

| 項目 | 之前 | 現在 |
|-----|------|------|
| 排序優先級 | 主規章 > 相似度 | 相似度（唯一標準） |
| 文件標記 | ⭐ 主規章優先 | ✨ 最相關文件 |
| Prompt 指引 | 優先使用主規章 | 使用最相關文件 |
| 選擇邏輯 | 固定優先主規章 | 動態選擇最相關 |

---

## 🚀 部署說明

### 自動生效
- 後端 nodemon 會自動重啟
- 無需重啟前端

### 手動重啟（如需）
```bash
# 重啟後端
cd backend
npm run dev

# 前端無需重啟
```

### 驗證
重新執行「生成建議」流程，檢查結果是否按相似度選擇文件。

---

## 💡 設計理念

### 為什麼這樣改？

1. **更精準的匹配**  
   RAG 已經通過向量相似度找到了最相關的文件，應該信任這個結果。

2. **附件範本的價值**  
   很多法規修正（如合約條款、資安要求）直接對應附件範本，而不是主規章。

3. **避免錯誤建議**  
   如果主規章不相關，強制生成建議會導致不準確或無意義的修改。

4. **動態適應**  
   根據具體法規條文的內容，動態選擇最合適的內規文件。

---

## 📚 相關文件

- `backend/src/routes/suggest.js` - 文件排序邏輯
- `backend/src/services/llm/gemini-service.js` - Prompt 指引
- `backend/src/routes/match.js` - RAG 檢索（未修改）

---

最後更新: 2025-10-22  
版本: v2.0 - 相似度優先策略

